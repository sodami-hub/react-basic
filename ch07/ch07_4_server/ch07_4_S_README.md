# 07-4 JSON ì›¹ í† í°ìœ¼ë¡œ íšŒì› ì¸ì¦ ê¸°ëŠ¥ êµ¬í˜„í•˜ê¸° 
# âœ¨ì„œë²„
  
## ğŸˆ ì‚¬ìš©ì ì¸ì¦ê³¼ JSON ì›¹ í† í°
ì‚¬ìš©ì ì¸ì¦ì€ ì£¼ë¡œ ì‚¬ìš©ìë¥¼ êµ¬ë¶„í•˜ëŠ” ëª©ì ìœ¼ë¡œ ì´ìš©ë˜ë¯€ë¡œ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ì„œë²„ì— ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì •ë³´ë¥¼ ì €ì¥í•œë‹¤. í•˜ì§€ë§Œ êµ¬ê¸€ì´ë‚˜ í˜ì´ìŠ¤ë¶,
ë„¤ì´ë²„, ì¹´ì¹´ì˜¤ì™€ ê°™ì€ ë‹¤ë¥¸ ì‚¬ì´íŠ¸ì—ì„œ ì‚¬ìš©ìê°€ ê³¼ê±°ì— ì…ë ¥í•œ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ íšŒì› ê°€ì…ì„ í—ˆìš©í•˜ê¸°ë„ í•œë‹¤. ì´ëŸ° ë°©ì‹ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ì„œë²„ë“¤ì€
ëª¨ë‘ OAuthë¼ê³  í•˜ëŠ” í‘œì¤€ì— ê¸°ë°˜í•œë‹¤.  
OAuth(open standard for access delegation) ëŠ” RFC 5849 êµ­ì œ í‘œì¤€ìœ¼ë¡œ 2010ë…„ì— ë²„ì „ 1.0ì´ ë°œí‘œë˜ì—ˆìœ¼ë©° ì´í›„ 2012ë…„ì— ë²„ì „ 2.0ì´ ë°œí‘œëë‹¤.
1.0ë²„ì „ì„ OAuth1, 2.0 ë²„ì „ì„ OAuth2 ë¼ê³  í•œë‹¤. ê·¸ëŸ°ë° ì´ OAuthëŠ” ëª¨ë‘ JSON ì›¹ í† í°ì´ë€ ê¸°ìˆ ì— ê¸°ë°˜ì„ ë‘ê³  ìˆë‹¤.  
í† í°(token)ì€ ë³´í†µ ë¬¸ìì—´ì´ë‚˜ ìˆ«ìë¡œ ë§Œë“ ë‹¤. ë§Œì•½ ëª¨ë°”ì¼ ì•±ì´ í† í°ì„ ì „ì†¡í•œë‹¤ë©´ ì„œë²„ëŠ” ìˆ˜ì‹ í•œ í† í°ì„ í‚¤ë¡œ í•˜ì—¬ í•´ë‹¹ í† í°ì˜ ê°’ ë¶€ë¶„ì„ ì–»ì„ ìˆ˜ ìˆë‹¤.
JSON ì›¹ í† í°(ì¤„ì—¬ì„œ JWT)ì€ ì„ íƒì  ì„œëª…(optional signature)ê³¼ ì„ íƒì  ì•”í˜¸í™”(optional encryption) ê¸°ìˆ ì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ë§Œë“¤ê²Œ í•˜ëŠ”
ì¸í„°ë„· í‘œì¤€ì´ë©° ëª…ì¹­ì€ RFC 7159 ì´ë‹¤. JWTëŠ” HTTP í—¤ë”ì˜ Authorization í•­ëª©ì— ë‹¤ìŒì²˜ëŸ¼ `'Bearer' + ' ' +jwt` í˜•íƒœì˜ ê°’ìœ¼ë¡œ ì„œë²„ì— ì „ì†¡í•˜ëŠ”
ë°©ì‹ìœ¼ë¡œ ë™ì‘í•œë‹¤.
```typescript
headers: {
  Authorization: `Bearer ${jwt}`
}
```
ì´ëŸ¬í•œ HTTP í—¤ë”ë¥¼ ìˆ˜ì‹ ë°›ì€ ì„œë²„ëŠ” headersì˜ Authorization í•­ëª©ì—ì„œ JWT ê°’ì„ ì°¾ì•„ ì–´ë–¤ ì‘ì—…ì„ í•œ ë’¤, ê·¸ ê²°ê³¼ë¥¼ ë‹¤ì‹œ HTTP í—¤ë”ë¥¼ ë³´ë‚¸ ìª½ì— ì „ë‹¬í•œë‹¤.
JWT ê°’ì€ ì£¼ë¡œ íšŒì› ê°€ì…í•  ë•Œ, ì„œë²„ì—ì„œ ìƒì„±í•˜ì—¬ ì›¹ ë¸Œë¼ìš°ì € ìª½ í”„ëŸ°íŠ¸ì—”ë“œ í”„ë ˆì„ì›Œí¬ì— ì „ë‹¬í•œë‹¤. í”„ëŸ°íŠ¸ì—”ë“œ í”„ë ˆì„ì›Œí¬ ìª½ ì½”ë“œëŠ” ì´ë ‡ê²Œ ìˆ˜ì‹ í•œ JWT ê°’ì„
ë³´ê´€í•˜ê³  ìˆë‹¤ê°€, ì„œë²„ APIë¥¼ í˜¸ì¶œí•  ë•Œ HTTP headersì˜ Authorization í•­ëª©ì— ì‹¤ì–´ì„œ ì „ì†¡í•œë‹¤.

## ğŸˆ JWT ê¸°ëŠ¥ êµ¬í˜„í•˜ê¸° - ì„œë²„
Node.js í™˜ê²½ì—ì„œ JSON ì›¹ í† í°ê³¼ ê´€ë ¨ëœ ê¸°ëŠ¥ì€ jsonwebtoken ì´ë€ íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í•œë‹¤. ì„œë²„ì—ì„œ ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ jsonwebtoken ì„ ì„¤ì¹˜í•œë‹¤.
```shell
yarn add jsonwebtoken
yarn add -D @types/jsonwebtoken
```
jsonwebtokenì€ signê³¼ verify í•¨ìˆ˜ë¥¼ ì œê³µí•œë‹¤.
```typescript
import {sign, verify} from 'jsonwebtoken'
```
sign í•¨ìˆ˜ëŠ” ë‹¤ìŒ ì½”ë“œ í˜•íƒœë¡œ JSON ì›¹ í† í°ì„ ë§Œë“ ë‹¤. ì—¬ê¸°ì„œ secretì€ payload ë¥¼ ì•”í˜¸í™”í•  ë•Œ ì“°ëŠ” í‚¤ì´ë‹¤. sign í•¨ìˆ˜ëŠ” payload ë¥¼ secret ê³¼
option ë¶€ë¶„ì„ ê²°í•©í•´ JSON ì›¹ í† í°ì„ ìƒì„±í•œë‹¤.
```typescript
cosnt secret = 'ì§ì‘í•˜ê¸°_ì–´ë ¤ìš´_ë¬¸ìì—´'
const jwt = sign(payload, secret, option)
```
JWT ì˜ íŠ¹ì§•ì€ ìœ íš¨ ê¸°ê°„ì„ ì„¤ì •í•  ìˆ˜ ìˆë‹¤ëŠ” ì ì´ë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ë‹¤ìŒ ì½”ë“œëŠ” í•˜ë£¨('1d'ëŠ” 1dayì˜ ì˜ë¯¸)ë§Œ ìœ íš¨í•œ JWTë¥¼ ìƒì„±í•œë‹¤.
```typescript
sign({name: 'jack', password: '1234'}, secret, {expiresIn:'1d'})
```
ì´ë ‡ê²Œ ë§Œë“  jwt ê°’ì€ ë‹¤ìŒì²˜ëŸ¼ verify í•¨ìˆ˜ë¡œ ê²€ì¦í•  ìˆ˜ ìˆë‹¤.
```typescript
const decode = verify(jwt, secret, option)
```
jsonwebtoken íŒ¨í‚¤ì§€ê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì„ í”„ë¡œê·¸ë˜ë°ìœ¼ë¡œ ì¢€ ë” ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë§Œë“¤ì–´ ë³´ê² ë”°. src/utils/jwtP.ts(í•¨ìˆ˜ ë’¤ì— 'P'ëŠ” Promise íƒ€ì„ ê°ì²´ë¥¼ ë°˜í™˜í•œë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.)
íŒŒì¼ì„ ìƒì„±í•˜ê³ , ì½”ë“œë¥¼ ì‘ì„±í•œë‹¤. ì´ ì½”ë“œì—ì„œëŠ” sign ì´ë‚˜ verify í•¨ìˆ˜ê°€ ì˜ˆì™¸ë¥¼ ì¼ìœ¼í‚¬ ë•Œ ì„œë²„ í”„ë¡œê·¸ë¨ì´ ë¹„ì •ìƒìœ¼ë¡œ ì¢…ë£Œë˜ëŠ” ê²ƒì„ ë§‰ê³ ì try/catch ë¬¸ì„
ì‚¬ìš©í•˜ê³  ìˆë‹¤. ì½”ë“œë¥¼ ì‘ì„±í•˜ê³  index.tsì— ë°˜ì˜í•œë‹¤.  
ì´ì œ jwtP.ts íŒŒì¼ì— êµ¬í˜„í•œ ë‘ í•¨ìˆ˜ë¥¼ í…ŒìŠ¤íŠ¸ í•˜ê¸° ìœ„í•´ì„œ src/test/jwtTest.ts íŒŒì¼ì„ ë§Œë“ ë‹¤. ê·¸ë¦¬ê³  ì½”ë“œë¥¼ ì‘ì„±í•œë‹¤. ì½”ë“œëŠ” ì •ìƒìœ¼ë¡œ JWT ë¥¼ ìƒì„±í•˜ê³  ìƒì„±ëœ í† í°ì„ ê²€ì¦í•˜ëŠ”
jwtNormalTest í•¨ìˆ˜ì™€ í† í°ì´ '1234' ë“± ë¹„ì •ìƒì ì¼ ë•Œë¥¼ ëŒ€ë¹„í•œ jwtExceptionTest, ê·¸ë¦¬ê³  í† í°ì˜ ìœ íš¨ ê¸°ê°„ì„ 1ì´ˆ(1s)ë¡œ í•œ ë‹¤ìŒ 2ì´ˆ í›„ì— í† í°ì„ ê²€ì¦í•˜ì—¬ ìœ íš¨ ê¸°ê°„ì´ ì§€ë‚œ
í† í°ì¼ ë•Œë¥¼ í…ŒìŠ¤íŠ¸í•˜ëŠ” jwtExpireTest í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•´ ë³´ëŠ” ë‚´ìš©ì´ë‹¤.  
í„°ë¯¸ë„ì—ì„œ jwtTest.ts íŒŒì¼ì„ ì‹¤í–‰í•œë‹¤. ì‹¤í–‰ê²°ê³¼ë¥¼ ë³´ë©´ ìƒì„±í•œ í† í°ê³¼ ë””ì½”ë”© ê²°ê³¼, ë¹„ì •ìƒ í† í°ì¼ ë•Œ, ê¸°í•œì´ ì§€ë‚¬ì„ ë•Œ
ì˜¤ë¥˜ë¥¼ ì°¨ë¡€ë¡œ ì¶œë ¥í•œë‹¤.

## ğŸˆ ë¹„ë°€ë²ˆí˜¸ í•´ì‹œê°’(ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” í•˜ê¸°) êµ¬í•˜ê¸°
ì´ë²ˆì—” ì‚¬ìš©ì ì¸ì¦ ê¸°ëŠ¥ìš© ë¼ìš°í„°ë¥¼ ì‘ì„±í•´ì•¼ í•˜ëŠ”ë° ê·¸ì— ì•ì„œ ë¹„ë°€ë²ˆí˜¸ì˜ í•´ì‹œê°’ì„ êµ¬í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³¸ë‹¤. ì‚¬ìš©ìê°€ íšŒì› ê°€ì…í•  ë•Œ ì„¤ì •í•œ
ë¹„ë°€ë²ˆí˜¸ë¥¼ ê·¸ëƒ¥ ì €ì¥í•˜ë©´ ë³´ì•ˆ ë¬¸ì œë¥¼ ì¼ìœ¼í‚¨ë‹¤. ë”°ë¼ì„œ ë¹„ë°€ë²ˆí˜¸ì˜ í•´ì‹œê°’ì„ ê³„ì‚°í•˜ì—¬ ì €ì¥í•´ì•¼ í•œë‹¤.  
Node.js í™˜ê²½ì—ì„œ ë¹„ë°€ë²ˆí˜¸ì™€ ê°™ì€ ë¬¸ìì—´ì€ bcrypt ë¼ëŠ” íŒ¨í‚¤ì§€ê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ ì‰½ê²Œ í•´ì‹œê°’ì„ êµ¬í•  ìˆ˜ ìˆë‹¤. ë¨¼ì € bcrypt íŒ¨í‚¤ì§€ë¥¼
ì„¤ì¹˜í•œë‹¤.
```shell
yarn add bcrypt
yarn add -D @types/bcrypt
```
bcrypt íŒ¨í‚¤ì§€ë¥¼ í†µí•´ ì–»ì€ bcrypt ê°ì²´ë¥¼ í†µí•´ hash ì™€ compare í•¨ìˆ˜ë¥¼ ë‹¤ìŒì²˜ëŸ¼ bcrypt.hash, bcrypt.compare
í˜•íƒœë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.  
Promise ë²„ì „ì¸ hash ì™€ compare í•¨ìˆ˜ë¥¼ ì´ìš©í•˜ì—¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ í•´ì‹œí•˜ëŠ” í•¨ìˆ˜ë¥¼ êµ¬í˜„í•˜ê² ë‹¤. ë¨¼ì € src/utils/hashPassword.ts íŒŒì¼ì„ ìƒì„±í•œë‹¤.
ê·¸ë¦¬ê³  ì½”ë“œë¥¼ ì‘ì„±í•˜ê³ , index.ts ì— í•´ë‹¹ íŒŒì¼ì„ ë°˜ì˜í•œë‹¤.  
ê·¸ë¦¬ê³  hashPasswordP.ts íŒŒì¼ì— êµ¬í˜„í•œ ë‘ í•¨ìˆ˜ë¥¼ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ì„œ src/test/hashTest.ts íŒŒì¼ì„ ìƒì„±í•˜ê³ , ì½”ë“œë¥¼ ì‘ì„±í•œë‹¤.
ì½”ë“œëŠ” í‰ë²”í•œ ë¬¸ìì—´ ë¹„ë°€ë²ˆí˜¸ë¥¼ password ë³€ìˆ˜ì— ì €ì¥í•œ ë‹¤ìŒ, hashPasswordP í•¨ìˆ˜ë¡œ ì´ ë¹„ë°€ë²ˆí˜¸ì˜ í•´ì‹œê°’ì„ êµ¬í•œë‹¤.
ê·¸ë¦¬ê³  comparePasswordP í•¨ìˆ˜ë¡œ í‰ë²”í•œ ë¹„ë°€ë²ˆí˜¸ì™€ í•´ì‹œê°’ì„ ë¹„êµí•œë‹¤.

## ğŸˆ ë¼ìš°í„° êµ¬í˜„í•˜ê¸°
ì•ì—ì„œ ë§Œë“  í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì„œ ë¼ìš°í„°ë¥¼ êµ¬í˜„í•´ ë³´ê² ë‹¤. ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ src/routers ë””ë ‰í„°ë¦¬ì— authRouter.ts íŒŒì¼ì„ ìƒì„±í•œë‹¤.
ê·¸ë¦¬ê³  ì½”ë“œë¥¼ ì‘ì„±í•œë‹¤.  
ì½”ë“œëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ì „ì†¡í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ê°€ì§„ ë¬¸ì„œê°€ ìˆëŠ”ì§€ íŒë³„í•˜ì—¬ ì´ë¯¸ ê°€ì…í•œ íšŒì›ì¸ì§€ë¥¼ ê°€ë ¤ë‚¸ë‹¤. ê·¸ë¦¬ê³  ì‹ ê·œ íšŒì›ì´ë©´ ì „ì†¡ëœ
ë¹„ë°€ë²ˆí˜¸ì˜ í•´ì‹œê°’ì„ êµ¬í•´ ì»¬ë ‰ì…˜ì— ì €ì¥í•˜ê³  ì»¬ë ‰ì…˜ì— ìƒì„±ëœ ë¬¸ì„œì˜ _idê°’ìœ¼ë¡œ JSON ì›¹ í† í°ì„ ë§Œë“¤ì–´ userId ì†ì„±ì— ì„¤ì •í•œë‹¤.
ì´ë¥¼ body ì†ì„±ì— ì„¤ì •í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ë¡œ ë³´ë‚¸ë‹¤. ì´ì œ í´ë¼ì´ì–¸íŠ¸ ìª½ì—ì„œ JSON í† í°ì„ ë³´ë‚´ë©´ ì´ í† í°ìœ¼ë¡œ userId ê°’ì„ ê°€ì§„ ë¬¸ì„œê°€
user ì»¬ë ‰ì…˜ì— ìˆëŠ”ì§€ í™•ì¸í•˜ì—¬ íšŒì› ê°€ì…í•œ ì‚¬ìš©ìê°€ ë³´ë‚¸ ìš”ì²­ì¸ì§€ë¥¼ ì•Œ ìˆ˜ ìˆë‹¤.  
ê°™ì€ ë””ë ‰í„°ë¦¬ì˜ index.ts ì— í•´ë‹¹ íŒŒì¼ì„ ì¶”ê°€í•˜ê³ , setupRouters.ts íŒŒì¼ì— authRouter ì— ëŒ€í•œ ê²½ë¡œë¥¼ ì„¤ì •í•œë‹¤.
ì¦‰, íšŒì› ê°€ì… ê²½ë¡œëŠ” '/auth/signup' ì´ ëœë‹¤.

## ğŸˆ ë¡œê·¸ì¸ ê¸°ëŠ¥ êµ¬í˜„í•˜ê¸°
ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ êµ¬í˜„í•œë‹¤. ê·¸ ì „ì— ëª½ê³ DB ì˜ ObjectId ì— ê´€í•´ ì•Œì•„ë³´ê² ë‹¤. ì»¬ë ‰ì…˜ì— ì €ì¥ë˜ëŠ” ë¬¸ì„œëŠ” í•­ìƒ ObjectId íƒ€ì…ì˜ _id ì†ì„±ì´ ìˆë‹¤.
ì´ì œ ë¬¸ìì—´ì„ ObjectId í˜•íƒœë¡œ ë³€í™”í•´ ì£¼ëŠ” stringToObjectId í•¨ìˆ˜ë¥¼ ë§Œë“ ë‹¤. src/mongodb/stringToObjectId.ts íŒŒì¼ì„ ë§Œë“¤ê³  ì½”ë“œë¥¼ ì‘ì„±í•œë‹¤.
ê·¸ë¦¬ê³  index.ts ì— íŒŒì¼ì„ ë°˜ì˜í•œë‹¤.  
ì´ì œ ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ êµ¬í˜„í•´ ë³´ê² ë‹¤. JSON í† í°ì€ HTTP ìš”ì²­ í—¤ë”ì—ì„œ Authorization ì†ì„±ì˜ ì„¤ì •ê°’ìœ¼ë¡œ ì„œë²„ì— ì „ì†¡ëœë‹¤.
```typescript
headers: {
  Authorization: `Bearer ${jwt}`
}
```
ì´ë ‡ê²Œ ì„œë²„ë¡œ ì „ì†¡ëœ HTTP ìš”ì²­ í—¤ë”ëŠ” ë‹¤ìŒ ì½”ë“œ í˜•íƒœë¡œ ì–»ì„ ìˆ˜ ìˆë‹¤.
```typescript
router.post(ê²½ë¡œ, (req,res) => {
  const header = req.headers
})
```
ë‹¤ë§Œ, í—¤ë”ê°€ ì—†ëŠ” ìš”ì²­ë„ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë‹¤ìŒì²˜ëŸ¼ ë°©ì–´í•˜ëŠ” ì½”ë“œê°€ í•„ìš”í•˜ë‹¤.
```typescript
router.post(ê²½ë¡œ, (req,res) => {
  const header = req.headers || {}
})
```
ë‹¤ë§Œ, í´ë¼ì´ì–¸íŠ¸ ìª½ì—ì„œ authorization ì†ì„±ê°’ì„ í•­ìƒ ì„¤ì •í•˜ì—¬ ë³´ë‚¸ë‹¤ê³  ì¥ë‹´í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ë‹¤ìŒì²˜ëŸ¼ ë°©ì–´í•˜ëŠ” ì½”ë“œê°€ í•„ìš”í•˜ë‹¤.
```typescript
router.post(ê²½ë¡œ, (req,res)=> {
  const {authorization} = req.headers || {}
  if (!authorization) {
    res.json({ok:false, errorMessage: 'JSON í† í°ì´ ì—†ìŠµë‹ˆë‹¤.'})
    return
  }
})
```
ê·¸ë¦¬ê³  authorization ì†ì„±ì— ë‹´ê¸´ JWT ëŠ” `'Bearer' + ê³µë°±(' ')ë¬¸ì + JSON_í† í°` í˜•íƒœë¡œ ë‹´ê²¨ ìˆìœ¼ë¯€ë¡œ ë‹¤ìŒê³¼ ê°™ì€
ì½”ë“œ í˜•íƒœë¡œ ì–»ì„ ìˆ˜ ìˆë‹¤.
```typescript
const tmp =authorization.split(' ')
if (tmp.length !== 2) {
  res.json({ok:false, errorMessage: 'í—¤ë”ì—ì„œ JWTë¥¼ ì°¾ì„ ìˆ˜ ì—†ë‹¤.'})
} else {
  const jwt = tmp[1]
}
```
ê·¸ë¦¬ê³  ì´ë ‡ê²Œ ì–»ì€ JWT ë¡œë¶€í„° user ì»¬ë ‰ì…˜ì˜ ë¬¸ì„œ _id ê°’ì„ ì–»ì–´ findOne ë©”ì„œë“œë¥¼ í†µí•´ JSON í† í°ì— ë‹´ê¸´ userId ê°’ì„
ê°€ì§„ ë¬¸ì„œë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.
```typescript
const decoded = (await U.jwtVerifyP(jwt)) as {userId: string}
const result = await user.findOne({_id:stringToObjectId(decoded.userId)})
```
ì´ëŸ¬í•œ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ src/routes ì˜ authRouter.ts íŒŒì¼ì—ì„œ post('/login') ë¼ìš°íŠ¸ ë¶€ë¶„ì„ êµ¬í˜„í•œë‹¤.




## ğŸˆ
### ğŸ•¸ï¸








































## ğŸˆ
### ğŸ•¸ï¸



